---
atitle: 강의30
category: fullstack-class
---

# 1.28

**복습**
문제1) org.doit.web.newlecture.dao 패키지 안에 
           NLNoticeDao.java 파일 삭제 후 에러 발생하면 
           에러 메시지 확인 후 해결.

**NLMemberShipService.java**

```java
@Service
public class NLMemberShipService implements MemberShipService {

	@Autowired
	private SqlSession sqlSession;
	
	@Override
	public void insertAndPointUpOfMember(Notice notice, String id) throws ClassNotFoundException, SQLException {
		NoticeDao mybatisNoticeDao = sqlSession.getMapper(NoticeDao.class);
		
		notice.setWriter(id);
		mybatisNoticeDao.insert(notice);
	}
}
```

이와같이 수정

문제2) NLMemberDao.java 도  mybatis 를 사용해서 수정 후
            NLMemberDao.java 파일 삭제 후 확인

**JoinusController.java**

```java
	@Autowired
	private SqlSession sqlSession;

join() {
		MemberDao mybatisMemberDao = sqlSession.getMapper(MemberDao.class);
		mybatisMemberDao.insert(member);
```



**root-context.xml**

```xml
<value>classpath:org/doit/web/newlecture/dao/mapper/NLMemberDao.xml</value>
```

위 코드 추가.



문제3) mybatis 설정 과정 상세히 적으세요.
          ㄱ. pom.xml: 의존모듈 mybatis, mybatis-spring 추가
          ㄴ. root-context.xml: SqlSessionFactoryBean, SqlSessionTemplate 추가 후 mapperLocations 의 list 에 value 로 xml 경로 지정
          ㄷ. xml: SQL 문 작성
          ㄹ. controller: @autowired 후 CRUD 

문제4) 공지사항 삭제 버튼 클릭시  [경고창] 처리 안됨-> 해결

views/customer/inc/layout.jsp

```jsp
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
```

head 태그에 혹은 body 태그의 첫 부분에 위 코드 추가.

> `</script>` 닫기태그를 없애면 에러가 난다.

---

**[DAO 에서 Alias]**

**root-context.xml**

```xml
<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    <property name="dataSource" ref="dataSource"/>
    <property name="mapperLocations">
        <list>
            <value>classpath:org/doit/web/newlecture/dao/mapper/NLNoticeDao.xml</value>
            <value>classpath:org/doit/web/newlecture/dao/mapper/NLMemberDao.xml</value>
        </list>
    </property>

    <!-- 추가 -->
    <property name="typeAliases">
        <list> 
            <value>org.doit.web.newlecture.vo.Member</value>
            <value>org.doit.web.newlecture.vo.Notice</value>
        </list>
    </property>		
</bean>
```

alias 를 사용할 수 있다.

```java
@Alias("Member")
```



```xml
<select id="getMember" resultType="Member">
    SELECT * 
    FROM MEMBER
    WHERE id = #{id}
</select>
```



---

11시 수업

STSMybatis03

p.575 스캔을 이용한 매퍼 검색 + 매퍼 자동 Dao 구현 (어노테이션)

xml 파일이 필요없다.

매퍼파일 (NLNoticeDao.xml) 필요없다.

매퍼 인터페이스 (NoticeDao.java) 만 있으면 된다. 검색해서 자동으로 빈으로 등록 -> 사용



컴포넌트 - 스캔 / 마이바티스 스캔 차이점

`@Controller` 클래스

`@Repository` 클래스

`@Service` 

`@Component` 

마이바이스

매퍼 인터페이스 스캔

1. root-context.xml 수정
2. 매퍼 인터페이스 = 매퍼파일 + 인터페이스
   - NLMemberDao.xml MemberDao.java
3. CustomerController.java 수정
   - JoinusController.java 수정





**root-context.xml**

```xml
<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    <property name="dataSource" ref="dataSource"/>
</bean>

<mybatis-spring:scan base-package="org.doit.web.newlecture.dao"/>
```

모두 지우고 이렇게만 남기고 추가한다.

namespaces 의 mybatis-spring 이 보이지 않으면 pom.xml 에 모듈을 추가한다.

mybatis-spring 체크

**MemberDao.java**

```java
public interface MemberDao {
	
	@Select("SELECT * FROM MEMBER WHERE id = #{id} ")
	Member getMember(String id) throws ClassNotFoundException, SQLException;
	
	@Insert("		INSERT INTO MEMBER " + 
			"		(id, pwd, name, GENDER, BIRTH, IS_LUNAR, CPHONE, EMAIL, HABIT, REGDATE)" + 
			"		VALUES (#{id}, #{pwd}, #{name}, #{gender}, #{birth}, #{is_lunar}, #{cphone}, #{email}, #{habit}, SYSDATE)")
	int insert(Member member) throws ClassNotFoundException, SQLException;
}
```





**NoticeDao.java 전체코드**

```java
public interface NoticeDao {
	
	@Select("		SELECT COUNT(*) CNT " + 
			"		FROM NOTICES " + 
			"		WHERE ${field} LIKE '%${query}%'")
	int getCount(@Param("field") String field, @Param("query") String query) throws ClassNotFoundException, SQLException;
	
	@Select("		SELECT * " + 
			"		FROM (" + 
			"		       SELECT ROWNUM NUM, N.* " + 
			"		       FROM (" + 
			"		              SELECT * " + 
			"		              FROM NOTICES " + 
			"		              WHERE ${param2} LIKE '%${param3}%' " + 
			"				      ORDER BY REGDATE DESC " + 
			"				    ) N" + 
			"			  ) " + 
			"		WHERE NUM BETWEEN 1 + (#{param1}-1)*15 AND 15 + (#{param1}-1)*15")
	List<Notice> getNotices(@Param("page") int page, @Param("field") String field, @Param("query") String query) throws ClassNotFoundException, SQLException;					
	
	@Delete("		DELETE NOTICES " + 
			"		WHERE seq = #{seq}		")
	int delete(@Param("seq") String seq) throws ClassNotFoundException, SQLException;
	
	@Update("		UPDATE NOTICES " + 
			"		SET title = #{title}, CONTENT= #{content}" + 
			"			, FILESRC= #{filesrc} " + 
			"		WHERE seq = #{seq}")
	int update(@Param("notice") Notice notice) throws ClassNotFoundException, SQLException;
	
	@Select("		SELECT * " + 
			"		FROM NOTICES " + 
			"		WHERE SEQ = #{seq} ")
	Notice getNotice(@Param("seq") String seq) throws ClassNotFoundException, SQLException;
	
	@SelectKey(before = true, keyProperty = "seq", resultType = String.class
			, statement = "		SELECT MAX(TO_NUMBER(SEQ))+1 " + 
					"			FROM NOTICES")
	@Insert("		INSERT INTO NOTICES" + 
			"	    ( SEQ, TITLE, CONTENT, WRITER, REGDATE, HIT, FILESRC) " + 
			"	    VALUES ( #{ seq } , #{ title }, #{ content } , #{ writer  }, SYSDATE, 0, #{filesrc, javaType=String,  jdbcType=VARCHAR} )")
	int insert(Notice notice) throws ClassNotFoundException, SQLException;
	
	// 트랜잭션 격리성을 연습하기 위해 메서드 추가.
	@Update("		UPDATE notices " + 
			"		SET hit = hit + 1 " + 
			"		WHERE seq = #{seq}	")
	public void hitUp(@Param("seq") String seq);
	
	@Select("		SELECT hit " + 
			"		FROM notices " + 
			"		WHERE seq = #{seq}")
	public int getHit(@Param("seq") String seq);
}
```

mapper 패키지를 없앤다.



**JoinusController.java**

```java
@Controller
@RequestMapping("/joinus/*")
public class JoinusController {
	
	@Autowired
	MemberDao memberDao;

	// 로그인
	@RequestMapping("login.htm")
	public String login() throws Exception {
//		return "login.jsp";
		return "joinus.login";
	}
	
	@RequestMapping(value = {"join.htm"}, method = RequestMethod.GET)
	public String join() throws Exception {
//		return "join.jsp";
		return "joinus.join";
	}
	
	@RequestMapping(value = {"join.htm"}, method = RequestMethod.POST)
	public String join(Member member) throws Exception {
		memberDao.insert(member);
		return "redirect:../index.htm";
	}
}
```

`SqlSession` 제거 후 `noticeDao` 로 다시 수정한다.



```java
@Controller
@RequestMapping("/customer/*")
public class CustomerController {
	
	@Autowired
	private NoticeDao noticeDao;

	public NoticeDao getNoticeDao() {
		return noticeDao;
	}

	public void setNoticeDao(NoticeDao noticeDao) {
		this.noticeDao = noticeDao;
	}
	
	@Autowired
	private MemberShipService memberShipService;
	

	// 파일 추가
	// download.htm?p=customer/upload&f=a.txt
	   @RequestMapping("download.htm")
	   public void download(
	         @RequestParam("p") String p
	         , @RequestParam("f") String f
	         , HttpServletRequest request
	         , HttpServletResponse response)
	               throws IOException {

	      /*파일 이름에 대한 인코딩 처리 추가*/       
	      String fname =  f; //  new String(f.getBytes("ISO8859_1"), "UTF-8"); // f 
	      response.setHeader("Content-Disposition","attachment;filename="+ new String(fname.getBytes(), "ISO8859_1"));      
	      /*파일 다운로드가 가능하도록 하기 위한 물리적 경로*/
	      String fullPath = request.getSession().getServletContext().getRealPath(   p + "/" + fname);
	      /*파일 다운로드에 대한 처리 과정 추가*/
	      FileInputStream fin = new FileInputStream(fullPath);
	      ServletOutputStream sout = response.getOutputStream(); // 응답 스트림
	      byte[] buf = new byte[1024];
	      int size = 0;
	      while((size = fin.read(buf, 0, 1024)) != -1) {
	         sout.write(buf, 0, size); 
	      }
	      fin.close();
	      sout.close();
	   } // method
	
	
	// 글 삭제
	@RequestMapping("noticeDel.htm")
	public String noticeDel(String seq
			, String oFilesrc
			, HttpServletRequest request
	) throws Exception {
//		if (attachFileName != null) {
			String uploadRealPath = request.getSession().getServletContext().getRealPath("/customer/upload");
			File delOFile = new File(uploadRealPath, oFilesrc);
			
			if (delOFile.exists()) {
				delOFile.delete();
			}
//		}

		// ㄴ. DB 삭제
		noticeDao.delete(seq);
		return "redirect:notice.htm";
	}

	// 글 수정
	@RequestMapping(value = {"noticeEdit.htm"}, method = RequestMethod.GET)
	public String noticeEdit(String seq, Model model) throws Exception {
		Notice notice = noticeDao.getNotice(seq);
		model.addAttribute("notice", notice);
		return "customer.noticeEdit";
	}
	
	@RequestMapping(value = {"noticeEdit.htm"}, method = RequestMethod.POST)
	public String noticeEdit(
			Notice notice
			, @RequestParam("oFilesrc") String oFilesrc // 원래 첨부파일 유무 체크
			, HttpServletRequest request
			) throws Exception {
		String uploadRealPath = request.getSession().getServletContext().getRealPath("/customer/upload");
		CommonsMultipartFile multipartFile = notice.getFile();
		
		if (!multipartFile.isEmpty()) { // 새로 첨부파일 있다면
			// 원래 첨부된 파일이 있다면 삭제.
			File delOFile = new File(uploadRealPath, oFilesrc);
			
			if (delOFile.exists()) {
				delOFile.delete();
			}
			// ㄱ. upload 폴더 - 저장
			System.out.println("> uploadRealPath: " + uploadRealPath);
			String originalFilename = multipartFile.getOriginalFilename(); // a.txt
			originalFilename = getFileNameCheck(uploadRealPath, originalFilename);
			File dest = new File(uploadRealPath, originalFilename);
			multipartFile.transferTo(dest); // 업로드 폴더에 파일 저장.

			// ㄴ. notice.filesrc 업로드된 파일이름 저장: a.txt -> [a-1.txt]
			notice.setFilesrc(originalFilename);
		} else { // 새로 첨부파일 있다면
			notice.setFilesrc(oFilesrc);
		}
		
		int rowCount = noticeDao.update(notice);
		return "redirect:noticeDetail.htm?seq=" + notice.getSeq();
	}

	// 글 작성
	@RequestMapping(value = {"noticeReg.htm"}, method = RequestMethod.GET)
	public String noticeReg() throws Exception {
		// 제목, 내용 + 첨부된 파일 X
		// 1. dao.insert~()
		// 2. 글 목록 notice.htm 요청
		return "customer.noticeReg";
	}
	
	public String getFileNameCheck(String uploadPath 
			, String originalFilename) {   
		int index = 1;
		
		while(true) {
			File f = new File(uploadPath, originalFilename); // 파일객체
			if( !f.exists()) return originalFilename;    
			originalFilename = 
					originalFilename.substring(0, originalFilename.length()-4)
					+" - "
					+ (index++)
					+ originalFilename.substring(originalFilename.length()-4); 
		} // while 문 닫기
	}
	
	@RequestMapping(value = {"noticeReg.htm"}, method = RequestMethod.POST)
	public String noticeReg(
			Notice notice
			, HttpServletRequest request
			, Principal principal
			) throws Exception {
		CommonsMultipartFile multipartFile = notice.getFile();
		String uploadRealPath = null;
		
		// 첨부된 파일 있다면
		if (!multipartFile.isEmpty()) {
			
			// ㄱ. upload 폴더 - 저장
			uploadRealPath = request.getSession().getServletContext().getRealPath("/customer/upload");
			System.out.println("> uploadRealPath: " + uploadRealPath);
			String originalFilename = multipartFile.getOriginalFilename(); // a.txt
			originalFilename = getFileNameCheck(uploadRealPath, originalFilename);
			File dest = new File(uploadRealPath, originalFilename);
			multipartFile.transferTo(dest); // 업로드 폴더에 파일 저장.
			
			// ㄴ. notice.filesrc 업로드된 파일이름 저장: a.txt -> [a-1.txt]
			notice.setFilesrc(originalFilename);
		}
		
		/*
		int rowCount = noticeDao.insert(notice);
		
		if (rowCount == 1) {
			// 스프링에서 리다이렉트 redirect: 접두어 붙이자.
			return "redirect:notice.htm";
		} else {
			return "noticeReg.jsp?error";
		}
		*/
//		noticeDao.insertAndPointUpOfMember(notice, "kk0939");
		// notice.setWriter(principal.getName()); 이 맞다.
		memberShipService.insertAndPointUpOfMember(notice, principal.getName());
		return "redirect:notice.htm";
	}
	
	// 글 목록
	@RequestMapping("notice.htm")
	public String notices(
			@RequestParam(value = "page", defaultValue = "1")int page
			, @RequestParam(value = "field", defaultValue = "title")String field
			, @RequestParam(value = "query", defaultValue = "")String query
			, Model model
			) throws Exception {
		
//		List<Notice> list = this.noticeDao.getNotices(page, field, query);
		List<Notice> list = noticeDao.getNotices(page, field, query);
		
		model.addAttribute("test", "Hello.Spring MVC World!");
		model.addAttribute("list",list);
		
		// 총 레코드 수, 총 페이지 수
		int rowCount = noticeDao.getCount(field, query);
		int pageCount = (int) Math.ceil((double) rowCount / 15);
		model.addAttribute("pageCount", pageCount);
		
//		return "notice.jsp";
		return "customer.notice";
	}

	// 글 보기
	@RequestMapping("noticeDetail.htm")
	public String noticeDetail(
			String seq
			, Model model
			) throws Exception {
		
		// 인증
		noticeDao.hitUp(seq);
		model.addAttribute("test", "Hello.Spring MVC World!");
		Notice notice = noticeDao.getNotice(seq);
		model.addAttribute("notice",notice);
		return "customer.noticeDetail";
	}
}
```

`SqlSession` 제거 후 `noticeDao` 로 다시 수정한다.

```java
@Service
public class NLMemberShipService implements MemberShipService {

	@Autowired
	private NoticeDao noticeDao;
	
	@Override
	public void insertAndPointUpOfMember(Notice notice, String id) throws ClassNotFoundException, SQLException {
		notice.setWriter(id);
		noticeDao.insert(notice);
	}
}
```

11시 47 분 
10분 휴식
12시 에러  파일 확인 해서 에러 처리
"코드로 배우는 스프링 웹 프로젝트 "
Part1 부분 읽어 보기.

**Notice.java**

```java
@Update("		UPDATE NOTICES " + 
        "		SET title = #{notice.title}, CONTENT= #{notice.content}" + 
        "			, FILESRC= #{notice.filesrc} " + 
        "		WHERE seq = #{notice.seq}")
int update(@Param("notice") Notice notice) throws ClassNotFoundException, SQLException;

@SelectKey(before = true, keyProperty = "seq", resultType = String.class
           , statement = "		SELECT MAX(TO_NUMBER(SEQ))+1 " + 
           "			FROM NOTICES")
@Insert("		INSERT INTO NOTICES" + 
        "	    ( SEQ, TITLE, CONTENT, WRITER, REGDATE, HIT, FILESRC) " + 
        "	    VALUES ( #{ seq } , #{ notice.title }, #{ notice.content } , #{ notice.writer  }, SYSDATE, 0"
        + "		, #{notice.filesrc, javaType=String,  jdbcType=VARCHAR} )")
int insert(Notice notice) throws ClassNotFoundException, SQLException;
```

update 는 되는데 insert 는 여전히 에러가 난다.



---

**오후수업**

