---
atitle: 강의26
category: fullstack-class
---

# 1.17

18, 20, 21일 팀별 취업설명회

4시 30분 전에 수업 끝낸다.



스프링 + 마이비티스

오전 - 발표 + 마무리

오후 2시 - 스프링



![image-20220117103319296](../../../assets/images/image-20220117103319296.png)

Part 1, 2

12시에 점심먹고 2시사이 모두 읽어보기

오전 10:30 ~ 11:50 수업

---

Spring 환경설정

1. Class 폴더
   - SpringClass 폴더생성
2. springDI 이름으로 java project 생성 



1. 스프링 프레임워크 개요
2. 핵심기능 - DI, AOP
   - DI 를 사용해서 객체 생성
     - xml 파일 - Ex02.java
     - 자바파일
   - 스프링 빈 라이프 사이클
   - AOP
     - POJO 기반
     - 어노테이션 기반
3. 스프링 MVC
4. 스프링 JDBC
5. 스프링 트랜잭션
6. 스프링 PRM - mybatis 
7. 스프링 보안



spring: https://spring.io/team 



1. 스프링 프레임워크 개요
   - 스프링 설치: 3.x 4.x 5.x. zip 메이븐
     - 메이븐 - 빌드도구 +++ 프로젝트 생성 ~ 배포
     - 중앙저장소 -> 다운로드 -> `.jar` 모듈
     - `pom.xml` 파일
     - 그래들



1. Record 인터페이스
2. RecordImpl 클래스
3. RecordView 인터페이스
4. RecordViewImpl 클래스 생성



예) 한 학생의 국, 영, 수 정보를 입력하고 출력하기



DI (의존성주입)

- 생성자를 사용해서 DI
- setter 를 사용해서 DI



스프링

- 주요 모듈 jar 파일 추가
  - 메이븐 (빌드도구): pom.xml
- 객체생성 + DI: xml 파일 추가 (applicationContext.xml)



우클릭 - build path - libraries 탭

Add External JARs... 클릭 - 

spring-framework-3.0.2.RELEASE-with-docs 가 메인이다.

dist 폴더의 jar 파일을 전부 선택한다. (Ctrl A) - Apply - close 



예시파일

```
C:\spring-framework-3.0.2.RELEASE-with-docs\spring-framework-3.0.2.RELEASE\docs\spring-framework-reference\htmlsingle\spring-framework-reference.html
```

```
file:///C:/spring-framework-3.0.2.RELEASE-with-docs/spring-framework-3.0.2.RELEASE/docs/spring-framework-reference/htmlsingle/spring-framework-reference.html
```

주소창에 복사해도 된다.

`3.2.1. Configuration metadata`  클릭

예시

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  <bean id="..." class="...">
    <!-- collaborators and configuration for this bean go here -->
  </bean>

  <bean id="..." class="...">
    <!-- collaborators and configuration for this bean go here -->
  </bean>

  <!-- more bean definitions go here -->

</beans>
```



spring bean 이라고 한다.



스프링의 객체생성

```xml
<bean id="record" class="di.RecordImpl"></bean>
<bean id="service" class="di.RecordViewImpl">
    <property name="record" ref="record"></property>
</bean>
```

> 꼭 class 에 패키지도 작성한다.

`ref` id 를 가리킨다.

`name` setRecord 함수를 가리킨다.



스프링빈 - Application Context == 스프링 컨테이너

`gx` GenericXmlApplicationContext ctx



에러

```
Exception in thread "main" java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory
Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory
```

해결: com.springsource.org.apache.commons.logging-1.1.1.jar 파일을 추가한다.



dependencies 에서 logging 검색

```
C:\spring-framework-3.0.2.RELEASE-dependencies\org.apache.commons\com.springsource.org.apache.commons.logging\1.1.1
```



**xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
	<bean id="record" class="di.RecordImpl"></bean>
	<bean id="service" class="di.RecordViewImpl">
		<property name="record" ref="record"></property>
	</bean>
</beans>
```

**java**

```java
String resourceLocations = "applicationContext.xml";
GenericXmlApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations);
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");

service.input();
service.output();
System.out.println(" = END = ");
```



생성자를 사용해서 DI

```xml
<bean id="record" class="di.RecordImpl"></bean>
<bean id="service" class="di.RecordViewImpl">
    <constructor-arg ref="record"></constructor-arg>
</bean>
```



챕터 part 1 꼭 볼 것. 154p 까지



```xml
<bean id="record" class="di.RecordImpl"></bean>
<bean id="service" class="di.RecordViewImpl">
    <constructor-arg>
        <ref bean="record"></ref>
    </constructor-arg>
</bean>
```

같은코드



applicationContext.xml 파일 대신에 자바파일을 사용 - di.Config.java

**Config.java**

```java
@Configuration
public class Config {
	
	@Bean
	public RecordImpl record() {
		return new RecordImpl();
	}
	
	@Bean
	public RecordViewImpl getRecordViewImpl() {
		// 1. 생성자 DI
//		return new RecordViewImpl(record());
		
		// 2. setter DI
		RecordViewImpl service = new RecordViewImpl();
		service.setRecord(record());
		return service;
	}
}
```



applicationContext.xml 파일 대신할 자바파일



오류

```
Exception in thread "main" java.lang.IllegalStateException: CGLIB is required to process @Configuration classes. Either add CGLIB to the classpath or remove the following @Configuration bean definitions: [config]
```

해결: CGLIB 라이브러리를 추가한다.

```
C:\spring-framework-3.0.2.RELEASE-dependencies\net.sourceforge.cglib\com.springsource.net.sf.cglib\2.2.0\com.springsource.net.sf.cglib-2.2.0.jar
```



오류

```
Exception in thread "main" java.lang.IllegalStateException: Cannot load configuration class: di.Config
Caused by: java.lang.ExceptionInInitializerError
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not "opens java.lang" to unnamed module @401e7803
```

해결: JRE 를 openjdk 가 아니라 우리가 설치한 jre 를 사용한다.

libraries 클릭 후 Edit - Alternate Installed  - directory - 

```
C:\Program Files\Java\jre1.8.0_301
```





오류

```
Exception in thread "main" org.springframework.beans.factory.NoSuchBeanDefinitionException: No bean named 'service' is defined
```





**Config.java**

```java
public class Config {
	
	@Bean
	public RecordImpl record() {
		return new RecordImpl();
	}
	
	@Bean(name="service")
	public RecordViewImpl getRecordViewImpl() {
		// 1. 생성자 DI
//		return new RecordViewImpl(record());
		
		// 2. setter DI
		RecordViewImpl service = new RecordViewImpl();
		service.setRecord(record());
		return service;
	}
}
```



**Ex02.java**

```java
public class Ex02 {
	public static void main(String[] args) {
		AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext(Config.class);
		RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
		
		service.input();
		service.output();
		System.out.println(" = END = ");
	}
}
```



**[springDI03]**

자동으로 DI p.105

1. `@Autowired` 클래스이름으로 적용
2. `@Resource` name 으로 적용
3. `@Inject` 가장 최근



**applicationContext.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
           
	<bean id="record" class="di.RecordImpl"></bean>
	<!-- 자동으로 의존성 주입 -->
	<bean id="service" class="di.RecordViewImpl"></bean>
</beans>
```

**RecordViewImpl.java**

```java
@Autowired
private RecordImpl record = null;
```



Autowired 또는 Resource 어노테이션을 사용하려면 추가

**applicationContext.xml**

```xml
xmlns:context="http://www.springframework.org/schema/context"

http://www.springframework.org/schema/context           http://www.springframework.org/schema/context/spring-context.xsd

<context:annotation-config></context:annotation-config>
```

추가



전체코드

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">

	<context:annotation-config></context:annotation-config>
           
	<bean id="record" class="di.RecordImpl"></bean>
	<!-- 자동으로 의존성 주입 -->
	<bean id="service" class="di.RecordViewImpl"></bean>
</beans>
```



**[springDI04]**

빈 객체를 자동으로 스캔해서 생성 + DI



**applicationContext.xml**

```xml
<context:component-scan base-package="di"></context:component-scan>
```



```java
@Component
public class RecordImpl implements Record {
```

어노테이션을 붙이면 스캔한다.



전체코드

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">
           <context:component-scan base-package="di"></context:component-scan>
</beans>
```

오류

```
Exception in thread "main" org.springframework.beans.factory.NoSuchBeanDefinitionException: No bean named 'service' is defined
```



RecordViewImpl 클래스가 자동으로 bean 생성이 되어지면 그 이름은 recordViewImpl 이 된다.

```java
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
```

> getBean("recordViewImpl") 라고 해야한다. 
>
> 혹은 `@Component("service")` 라고 해야한다.



**전체코드**

**applicationContext.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">
           <context:component-scan base-package="di"></context:component-scan>
</beans>
```

**RecordViewImpl.java**

```java
@Component("service")
public class RecordViewImpl implements RecordView {
	@Autowired
	private RecordImpl record = null;

	public RecordImpl getRecord() {
		return record;
	}
	public void setRecord(RecordImpl record) {
		this.record = record;
	}
	
	public RecordViewImpl() {}		
	public RecordViewImpl(RecordImpl record) {		
		this.record = record;
	}

	@Override
	public void input() {
		try(Scanner scanner = new Scanner(System.in)) {
			System.out.print("> kor, eng, mat input ? ");
			
			record.setKor(scanner.nextInt());
			record.setEng(scanner.nextInt());
			record.setMat(scanner.nextInt());
			
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	@Override
	public void output() {
		System.out.printf("> kor:%d, eng:%d, mat:%d, tot=:%d, avg:%.2f\n"
				, record.getKor()
				, record.getEng()
				, record.getMat()
				, record.total()
				, record.avg()
				);
	}
}
```



**Ex02.java**

```java
public class Ex02 {
	public static void main(String[] args) {
		String resourceLocations = "applicationContext.xml";
		GenericXmlApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations);
		RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
		
		service.input();
		service.output();
		System.out.println(" = END = ");
	}
}
```



## 복습

**목차**

1. xml 파일로 생성자 & setter
2. Config.java 파일로 생성자 & setter
3. `@Autowired` 자동으로 주입
4. `@Component` 객체생성까지 자동

**[springDI]**

xml 파일에 생성자 혹은 setter 로 주입

```java
String resourceLocations = "applicationContext.xml";
GenericXmlApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations);
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
```



```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
<!-- setter 를 통해 주입 -->
<!-- 	<bean id="record" class="di.RecordImpl"></bean> -->
<!-- 	<bean id="service" class="di.RecordViewImpl"> -->
<!-- 		<property name="record" ref="record"></property> -->
<!-- 	</bean> -->
	
	<bean id="record" class="di.RecordImpl"></bean>
	<bean id="service" class="di.RecordViewImpl">
		<constructor-arg>
			<ref bean="record"></ref>
		</constructor-arg>
	</bean>
</beans>
```



**[springDI02]**

자바파일로 주입

JavaSE-1.8 을 Jre 로 바꿔야한다.

```java
AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext(Config.class);
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
```



```java
@Configuration
public class Config {
	
	@Bean
	public RecordImpl record() {
		return new RecordImpl();
	}
	
	@Bean(name="service")
	public RecordViewImpl getRecordViewImpl() {
		// 1. 생성자 DI
//		return new RecordViewImpl(record());
		
		// 2. setter DI
		RecordViewImpl service = new RecordViewImpl();
		service.setRecord(record());
		return service;
	}
}
```



**[springDI03]**

context 관련 세 줄을 추가하고 `@Autowired` 한다.

```java
String resourceLocations = "applicationContext.xml";
GenericXmlApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations);
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
```

```java
@Autowired
private RecordImpl record = null;
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">

	<context:annotation-config></context:annotation-config>
           
	<bean id="record" class="di.RecordImpl"></bean>
	<!-- 자동으로 의존성 주입 -->
	<bean id="service" class="di.RecordViewImpl"></bean>
</beans>
```





**[springDI04]**

**Main**

```java
String resourceLocations = "applicationContext.xml";
GenericXmlApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations);
RecordViewImpl service = (RecordViewImpl) ctx.getBean("service");
```

**Impl**

```java
@Component("service")
public class RecordViewImpl implements RecordView {
	@Autowired
	private RecordImpl record = null;
```

**xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">
           <context:component-scan base-package="di"></context:component-scan>
</beans>
```

# 1.18

**[AOP]**

1. Java Project 추가 - springAOP

2. Ex01.java 추가

3. 로직처리코딩 + 로그기록 (공통적)

   - 쓰,목,수,삭 + 인증, 권한 (공통적)
   - 핵심관심사항 : 공통관심사항
   - core concern : cross-cutting concern
   - JSP - 필터
   - 중복코딩제거 - 

   - 스프링 AOP (Aspect Oriented Programming)
   - 스프링 - 인증, 권한, 보안 (시큐리티), 트랜잭션 처리 (AOP 방식)
   - 관점 지향적 프로그래밍

4. +++ 반드시 알아야할 AOP 용어 +++ (암기)

   - Aspect: 여러 객체에 공통으로 적용되는 기능 (공통기능)
   - Advice: 공통기능을 핵심기능에 [언제] 적용할지를 정의 - 전+후, 전, 후
   - Weaving: advice 를 핵심로직코드에 적용 (삽입) 하는 것.
   - Joinpoint: Advice 를 적용 (삽입) 가능하는 지점- 예) add() 메서드 호출
   - Pointcut: Advice 를 실제 적용한 지점.
     - 스프링에서는 정규표현식, [AspectJ문법] +++ 을 이용해서 Pointcut 을 설정할 수 있다.

5. 세가지의 Weaving 방식

   - 컴파일 시 
   - 클래스 로딩 시
   - 런타임 시
     - 프록시 (proxy) 기반으로 AOP 지원하기 때문에
     - Joinpoint 를 메서드만 사용할 수 있다.

6. 스프링 AOP 구현하는 3가지 방법

   - 스프링 API 이용한 AOP 구현 X
   - XML 스키마 기반의 POJO 클래스를 이용한 AOP 구현 O - xml 파일
   - AspectJ 에서 정의한 `@Aspect` 어노테이션 기반의 AOP 구현 O - `@Aspect` 어노테이션

7. Advice 종류

   - Before Advice
   - Around Advice
   - After Advice, After Throwing Advice, After Returning Advice





모듈추가: spring, CGLIB, logging, aopalliance



**CalculatorImpl.java**

```java
public class CalculatorImpl implements Calculator {
	@Override
	public int add(int x, int y) {
		int result = x + y;
		return result;
	}

	@Override
	public int sub(int x, int y) {
		int result = x - y; // 산술연산 로직처리 코딩부분
		return result;
	}

	@Override
	public int mult(int x, int y) {
		int result = x * y;
		return result;
	}

	@Override
	public int div(int x, int y) {
		int result = x / y;
		return result;
	}
}
```

**Ex02.java**

```java
public class Ex02 {
	public static void main(String[] args) {
//		ProxyFactoryBean pfb = new ProxyFactoryBean();
//		pfb.setProxyInterfaces(null);
		
		// 계산기의 산술연산하는 메서드를 호출할 때 연산처리시간을 로그로 기록하고 싶다.
		// Advice - 로그기록
		// Around Advice = 전 + 후		aop.advice.LogPrintAroundAdvice
		
		String resourceLocations = "applicationContext.xml";
		AbstractApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations );
		Calculator calc = (Calculator) ctx.getBean("calcProxy");
		
		System.out.println(calc.add(4, 2));
		System.out.println(calc.sub(4, 2));
		System.out.println(calc.mult(4, 2));
		System.out.println(calc.div(4, 2));
		System.out.println("= END =");
	}
}
```

**applicationContext.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">
           
	<bean id="calc" class="aop.CalculatorImpl"></bean>           
	<bean id="logPrintAroundAdvice" class="aop.advice.LogPrintAroundAdvice"></bean>           
	
	<!-- 스프링 AOP: 프록시기반 + 메서드 적용 -->
	<bean id="calcProxy" class="org.springframework.aop.framework.ProxyFactoryBean">
	
		<!-- [1] -->
		<property name="target" ref="calc"></property>
		
		<!-- [2] pointcut 설정 -->
		<property name="proxyInterfaces">
			<list>
				<value>aop.Calculator</value>
			</list>
		</property>
		
		<!-- [3] Advice 등록 -->
		<property name="interceptorNames">
			<list>
				<value>logPrintAroundAdvice</value>
			</list>
		</property>
	</bean>
</beans>
```

**LogPrintAroundAdvice.java**

```java
import org.aopalliance.intercept.MethodInterceptor;

public class LogPrintAroundAdvice implements MethodInterceptor {
	@Override
	public Object invoke(MethodInvocation method) throws Throwable {
		String methodName = method.getMethod().getName();
		
		// 로직처리 (공통기능)
		Log log = LogFactory.getLog(this.getClass());
		StopWatch sw = new StopWatch();
		
		log.info("> " + methodName + "() start.");
		sw.start();
		Object result = method.proceed(); // add()
		sw.stop();
		log.info("> " + methodName + "() stop.");
		log.info("> " + methodName + "() 처리시간: " + sw.getTotalTimeMillis() + "ms");
		return result;
	}
}
```





출력

```
1월 18, 2022 11:11:06 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() start.
1월 18, 2022 11:11:06 오전 aop.advice.LogPrintBeforeAdvice before
정보: >>>add(): BeforeAdvice 가 호출됨...
1월 18, 2022 11:11:06 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() stop.
1월 18, 2022 11:11:06 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() 처리시간: 2ms
6
= END =
```



스프링 AOP: 프록시기반 + 메서드 적용

**applicationContext.xml**

```xml
<bean id="logPrintBeforeAdvice" class="aop.advice.LogPrintBeforeAdvice"></bean>

<value>logPrintBeforeAdvice</value>
```

**LogPrintBeforeAdvice.java**

```java
public class LogPrintBeforeAdvice implements MethodBeforeAdvice {

	// add(4, 2) 가정을 하면
	@Override
	public void before(
			Method method	// add()
			, Object[] arg	// 4, 2
			, Object target	// 핵심기능을 구현한 실제객체 calc
			) throws Throwable {
		String methodName = method.getName();
		Log log = LogFactory.getLog(getClass());
		log.info(">>>" + methodName + "(): BeforeAdvice 가 호출됨...");
	}
}
```



- afterThrowing
- afterReturning





```
1월 18, 2022 11:18:19 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() start.
1월 18, 2022 11:18:19 오전 aop.advice.LogPrintBeforeAdvice before
정보: >>>add(): BeforeAdvice 가 호출됨...
1월 18, 2022 11:18:19 오전 aop.advice.LogPrintAfterReturningAdvice afterReturning
정보: >>>add(): AfterReturningAdvice 가 호출됨...6
1월 18, 2022 11:18:19 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() stop.
1월 18, 2022 11:18:19 오전 aop.advice.LogPrintAroundAdvice invoke
정보: > add() 처리시간: 3ms
6
= END =
```

```java
public class LogPrintAfterReturningAdvice implements AfterReturningAdvice {

	@Override
	public void afterReturning(
			Object returnValue
			, Method method
			, Object[] arg
			, Object target
			) throws Throwable {
		String methodName = method.getName();
		Log log = LogFactory.getLog(getClass());
		log.info(">>>" + methodName + "(): AfterReturningAdvice 가 호출됨..." + returnValue);
	}
}
```





**applicationContext.xml 전체코드**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">
           
	<bean id="calc" class="aop.CalculatorImpl"></bean>           
	<bean id="logPrintAroundAdvice" class="aop.advice.LogPrintAroundAdvice"></bean>           
	<bean id="logPrintBeforeAdvice" class="aop.advice.LogPrintBeforeAdvice"></bean>           
	<bean id="logPrintAfterReturningAdvice" class="aop.advice.LogPrintAfterReturningAdvice"></bean>           
	
	<!-- 스프링 AOP: 프록시기반 + 메서드 적용 -->
	<bean id="calcProxy" class="org.springframework.aop.framework.ProxyFactoryBean">
	
		<!-- [1] -->
		<property name="target" ref="calc"></property>
		
		<!-- [2] pointcut 설정 -->
		<property name="proxyInterfaces">
			<list>
				<value>aop.Calculator</value>
			</list>
		</property>
		
		<!-- [3] Advice 등록 -->
		<property name="interceptorNames">
			<list>
				<value>logPrintAroundAdvice</value>
				<value>logPrintBeforeAdvice</value>
				<value>logPrintAfterReturningAdvice</value>
			</list>
		</property>
	</bean>
</beans>
```





**@component**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
			xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd">

<context:component-scan base-package="aop"/>           
<!-- 	<bean id="calc" class="aop.CalculatorImpl"></bean>            -->
<!-- 	<bean id="logPrintAroundAdvice" class="aop.advice.LogPrintAroundAdvice"></bean>            -->
<!-- 	<bean id="logPrintBeforeAdvice" class="aop.advice.LogPrintBeforeAdvice"></bean>            -->
<!-- 	<bean id="logPrintAfterReturningAdvice" class="aop.advice.LogPrintAfterReturningAdvice"></bean>            -->
	
	<bean id="calcProxy" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="target" ref="calc"></property>
	
		<property name="proxyInterfaces">
			<list>
				<value>aop.Calculator</value>
			</list>
		</property>
		<property name="interceptorNames">
			<list>
				<value>logPrintAroundAdvice</value>
				<value>logPrintBeforeAdvice</value>
				<value>logPrintAfterReturningAdvice</value>
			</list>
		</property>
	</bean>
</beans>
```



**[XML 스키마 기반 AOP 구현]**

p.209

1. advice 패키지 삭제
2. xml 내용 제거



스프링 AOP 3가지 방법 중에

+++ XML 스키마 기반 AOP 구현 +++

처리과정

1. 스프링 AOP 를 사용하기 위해 jar 의존파일 추가
   - weaver.jar 추가
2. aop.advice 패키지 -- 삭제
   - B, A, A advice 3가지
   - 공통기능을 제공할 클래스 추가
   - aop.LogPrintProfiler.java
     - trace() 구현 - Around Advice
3. xml 설정파일
   - `<aop:config>` aop 설정하는 태그
   - Aspect 를 설정
   - Advice 를 어떤 Pointcut 에 적용할지를 설정 (지정)

p.252 AspectJ 의 문법

pointcut 

1. execution 명시자
2. within 명시자
3. bean 명시자

```
execution(수식어패턴?리턴타입패턴 클래스이름패턴?메서드이름패턴(파라미터패턴))
```

수식어패턴

- public

리턴타입

- `int`
- `*` 상관없다.



**예시**

- ``execution(public void set*(..))` 리턴타입이 void 이고 메서드이름이 set 으로 시작하는 메서드
- `excution(* net.madvirus.spring4.chap06.*.*())` 파라미터가 없는 모든메서드
- `execution(* net.madvirus.spring4.chap06..*.*(..))` 패키지부분에 `..` 을 사용하여 해당피키지 혹은 하위 패키지를 나타낸다.





**xml**

추가

```xml
xmlns:aop="http://www.springframework.org/schema/aop"

http://www.springframework.org/schema/aop
http://www.springframework.org/schema/aop/spring-aop.xsd
```



전체코드

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           	http://www.springframework.org/schema/aop
			http://www.springframework.org/schema/aop/spring-aop.xsd
           ">

	<context:component-scan base-package="aop" />

	<aop:config>
		<aop:aspect id="traceAspect" ref="logPrintProfiler">
			<aop:around method="trace" pointcut="execution(public * aop..*.*(*,*))"/>
		</aop:aspect>
	</aop:config>
</beans>
```





**LogPrintProfiler.java**

```java
// before, after, around advice 를 대신할 공통기능을 구현할 클래스
public class LogPrintProfiler {
	
	// 1. Around Advice - 처리시간을 로그로 기록 (출력)
	public Object trace(ProceedingJoinPoint joinPoint) {
		String signature = joinPoint.getSignature().toShortString();
		
		Log log = LogFactory.getLog(this.getClass());
		StopWatch sw = new StopWatch();
		log.info("> " + signature + "() start.");
		sw.start();
		
		Object result = null;
		
		try {
			result = joinPoint.proceed();
		} catch (Throwable e) {
			e.printStackTrace();
		} finally {
			sw.stop();
			log.info("> " + signature + "() stop.");
			log.info("> " + signature + "() 처리시간: " + sw.getTotalTimeMillis() + "ms");
		}
		return result;
	}
}
```

`ProceedingJoinPoint` 계산코드



```java
@Component()
public class LogPrintProfiler {
```



```java
@Component("calc")
public class CalculatorImpl implements Calculator {
```



**Ex02.java**

```java
public class Ex02 {
	public static void main(String[] args) {
		String resourceLocations = "applicationContext.xml";
		AbstractApplicationContext ctx = new GenericXmlApplicationContext(resourceLocations );
		Calculator calc = (Calculator) ctx.getBean("calc");
		
		System.out.println(calc.add(4, 2));
//		System.out.println(calc.sub(4, 2));
//		System.out.println(calc.mult(4, 2));
//		System.out.println(calc.div(4, 2));
		System.out.println("= END =");
	}
}
```





**추가**

**LogPrintProfiler.java**

```java
import org.aspectj.lang.JoinPoint;
```



전체코드

```java
@Component()
public class LogPrintProfiler {
	
	// 1. Around Advice - 처리시간을 로그로 기록 (출력)
	public Object trace(ProceedingJoinPoint joinPoint) throws Exception {
		String signature = joinPoint.getSignature().toShortString();
		
		Log log = LogFactory.getLog(this.getClass());
		StopWatch sw = new StopWatch();
		log.info("> " + signature + "() start.");
		sw.start();
		
		Object result = null;
		
		try {
			result = joinPoint.proceed();
		} catch (Throwable e) {
			e.printStackTrace();
		} finally {
			sw.stop();
			log.info("> " + signature + "() stop.");
			log.info("> " + signature + "() 처리시간: " + sw.getTotalTimeMillis() + "ms");
		}
		return result;
	}
	
	public void before(JoinPoint joinpoint) {
		String methodName = joinpoint.getSignature().getName();
		Log log = LogFactory.getLog(this.getClass());
		log.info(">>> " + methodName + "() before advice.");
	}
	
	public void afterFinally(JoinPoint joinpoint) {
		String methodName = joinpoint.getSignature().getName();
		Log log = LogFactory.getLog(this.getClass());
		log.info(">>> " + methodName + "() after advice.");
	}
}
```



**xml**

```xml
<aop:config>
    <aop:aspect id="traceAspect" ref="logPrintProfiler">
        <aop:around method="trace" pointcut="execution(public * aop..*.*(*,*))"/>
        <aop:before method="before" pointcut="execution(public * aop..*.*(*,*))"/>
        <aop:after method="afterFinally" pointcut="execution(public * aop..*.*(*,*))"/>
    </aop:aspect>
</aop:config>
```



전체코드

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           	http://www.springframework.org/schema/aop
			http://www.springframework.org/schema/aop/spring-aop.xsd
           ">

	<context:component-scan base-package="aop" />

	<aop:config>
		<aop:aspect id="traceAspect" ref="logPrintProfiler">
			<aop:around method="trace" pointcut="execution(public * aop..*.*(*,*))"/>
			<aop:before method="before" pointcut="execution(public * aop..*.*(*,*))"/>
			<aop:after method="afterFinally" pointcut="execution(public * aop..*.*(*,*))"/>
		</aop:aspect>
	</aop:config>
</beans>
```





**포인트컷 참조**

```xml
<aop:pointcut expression="execution(public * aop..*.*(*,*))" id="publicMethod"/>
<aop:around method="trace" pointcut-ref="publicMethod"/>
<aop:before method="before" pointcut-ref="publicMethod"/>
<aop:after method="afterFinally" pointcut-ref="publicMethod"/>
```



전체코드

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           	http://www.springframework.org/schema/aop
			http://www.springframework.org/schema/aop/spring-aop.xsd
           ">

	<context:component-scan base-package="aop" />

	<aop:config>
		<aop:aspect id="traceAspect" ref="logPrintProfiler">
			<aop:pointcut expression="execution(public * aop..*.*(*,*))" id="publicMethod"/>
			<aop:around method="trace" pointcut-ref="publicMethod"/>
			<aop:before method="before" pointcut-ref="publicMethod"/>
			<aop:after method="afterFinally" pointcut-ref="publicMethod"/>
		</aop:aspect>
	</aop:config>
</beans>
```



**[세번째방법]**

`@Aspect` 어노테이션

